{% extends "base.html" %}

{% block "content" %}
<body class="background">
    <div class="container">
        <div class="text-center" style="margin-top: 1vw;">
            <h1>Tap to Scan</h1>
            <br />
        </div>

        <div style="margin: 0 auto;">
            <a onClick="takeASnap();" href="#"><video id="videoElement" autoplay playsinline></video></a>
            <form action="/analysis" method="post" id="form">
                {% csrf_token %}
                <input type="hidden" name="blob" id="blob" value="">
            </form>
        </div>
    </div>
</body>
{% endblock %}

{% block "footer" %}
  <script>
    var vid = document.querySelector("#videoElement");
    var constraints = {
         audio: false,
         video: {
             facingMode: 'environment'
         }
    }

    navigator.mediaDevices.getUserMedia(constraints).then(function success(stream) {
        vid.srcObject = stream;
    });

      
    function dataURItoBlob(dataURI) {
        // convert base64 to raw binary data held in a string
        var byteString = atob(dataURI.split(',')[1]);

        // separate out the mime component
        var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

        // write the bytes of the string to an ArrayBuffer
        var arrayBuffer = new ArrayBuffer(byteString.length);
        var _ia = new Uint8Array(arrayBuffer);
        for (var i = 0; i < byteString.length; i++) {
            _ia[i] = byteString.charCodeAt(i);
        }

        var dataView = new DataView(arrayBuffer);
        var blob = new Blob([dataView], { type: mimeString });
        return blob;
    }

    function takeASnap() {
      var canvas = document.createElement('canvas'); // create a canvas
      var ctx = canvas.getContext('2d'); // get its context
      canvas.width = vid.videoWidth; // set its size to the one of the video
      canvas.height = vid.videoHeight;
      ctx.drawImage(vid, 0,0); // the video
      var dataURL = canvas.toDataURL();
      $("#blob").val(dataURL);
      $("#form").submit();
    }

  </script>
{% endblock %}